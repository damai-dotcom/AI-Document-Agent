<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Matching Debug Page</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .search-form {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        .search-btn:hover {
            background: #0056b3;
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 20px;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
        }

        .result-item {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .result-score {
            background: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .result-content {
            color: #666;
            line-height: 1.5;
            max-height: 100px;
            overflow-y: auto;
        }

        .keywords {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 15px;
        }

        .keyword {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            margin: 2px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Search Matching Debug Tool</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Test document matching logic and view search results before LLM calls
        </p>

        <form class="search-form" id="searchForm">
            <input type="text" id="searchInput" class="search-input"
                placeholder="Enter a question, e.g.: What is our company's leave process?"
                value="What is our company's leave process">
            <button type="submit" class="search-btn" id="searchBtn">
                üîç Test Search Matching
            </button>
        </form>

        <div id="results" class="results"></div>
    </div>

    <script>
        const searchForm = document.getElementById('searchForm')
        const searchInput = document.getElementById('searchInput')
        const searchBtn = document.getElementById('searchBtn')
        const resultsDiv = document.getElementById('results')

        // Preset test questions (including synonym tests and token pressure tests)
        const testQueries = [
            'What is our company\'s leave process',
            'How to apply for annual leave',
            'What are the employee benefits',
            'New employee onboarding process',
            'What is the performance evaluation system',
            'What procedures are needed for resignation',
            'Training and development opportunities',
            'leave process',
            'annual leave',
            'employee benefits',
            'onboarding process',
            'performance review',
            'resignation process',
            'training and development',
            // Synonym tests
            'I want to take a few days off',
            'time off policy',
            'sick leave application',
            'I want to resign',
            'What about salary and benefits',
            'salary and benefits',
            'performance evaluation',
            'work performance assessment',
            // Token pressure tests
            'Please explain in detail all the company rules and benefit policies',
            'I want to understand the complete training system and career development path planning',
            'Please introduce in detail all the terms and precautions in the employee handbook'
        ]

        // Add quick test buttons
        function addQuickTestButtons () {
            const buttonsDiv = document.createElement('div')
            buttonsDiv.style.marginBottom = '20px'
            buttonsDiv.innerHTML = '<h3>Quick Tests:</h3>'

            testQueries.forEach(query => {
                const btn = document.createElement('button')
                btn.textContent = query
                btn.style.cssText = 'margin: 5px; padding: 8px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;'
                btn.onclick = () => {
                    searchInput.value = query
                    searchForm.dispatchEvent(new Event('submit'))
                }
                buttonsDiv.appendChild(btn)
            })

            searchForm.parentNode.insertBefore(buttonsDiv, searchForm.nextSibling)
        }

        async function performSearch (query) {
            searchBtn.disabled = true
            searchBtn.textContent = 'üîÑ Searching...'
            resultsDiv.innerHTML = '<div class="loading">Searching for matching documents...</div>'

            try {
                // Try multiple possible API endpoints
                const apiUrls = [
                    'http://localhost:5000/api/search-debug',
                    '/api/search-debug'
                ]

                let response
                let lastError

                for (const apiUrl of apiUrls) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json;charset=UTF-8'
                            },
                            body: JSON.stringify({ query: query })
                        })

                        if (response.ok) {
                            break
                        }
                    } catch (err) {
                        lastError = err
                        continue
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(lastError?.message || `Unable to connect to backend service. Please ensure backend service is running at http://localhost:5000`)
                }

                const data = await response.json()
                displayResults(data, query)

            } catch (error) {
                console.error('Search failed:', error)
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>Search failed:</strong> ${error.message}<br>
                        <strong>Solutions:</strong><br>
                        1. Ensure backend service is started: python simple_offline_backend.py<br>
                        2. Check if backend is running at http://localhost:5000<br>
                        3. Check if firewall is blocking the connection
                    </div>
                `
            } finally {
                searchBtn.disabled = false
                searchBtn.textContent = 'üîç Test Search Matching'
            }
        }

        function displayResults (data, query) {
            let html = ''

            // Debug information
            if (data.debug) {
                html += `
                    <div class="debug-info">
                        <strong>üîç Debug Information:</strong><br>
                        Original query: "${data.debug.original_query}"<br>
                        Extracted keywords: [${data.debug.keywords.map(k => `"${k}"`).join(', ')}]<br>
                        Search time: ${data.debug.search_time || 'N/A'}ms<br>
                        Matched documents: ${data.debug.matched_docs || 0}<br>
                        Total documents: ${data.debug.total_docs || 0}
                    </div>
                `
            }

            // Keywords display
            if (data.debug && data.debug.keywords) {
                html += `
                    <div class="keywords">
                        <strong>üéØ Extracted Keywords:</strong><br>
                        ${data.debug.keywords.map(k => `<span class="keyword">${k}</span>`).join('')}
                    </div>
                `
            }

            // Search results
            if (data.results && data.results.length > 0) {
                html += `<h3>üìÑ Matched Documents (${data.results.length}):</h3>`

                data.results.forEach((result, index) => {
                    html += `
                        <div class="result-item">
                            <div class="result-title">
                                ${result.title}
                                <span class="result-score">Match rate: ${(result.score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="result-content">
                                ${result.content.substring(0, 200)}...
                            </div>
                        </div>
                    `
                })
            } else {
                html += `
                    <div class="error">
                        ‚ùå No matching documents found
                        ${data.debug ? `<br>Suggestion: Try using keywords like "leave", "annual leave", "onboarding", "benefits", etc.` : ''}
                    </div>
                `
            }

            // LLM input preview and Token optimization information
            if (data.llm_input) {
                const llmInput = data.llm_input
                const tokenEstimate = llmInput.token_estimate || 0
                const optimizedDocs = llmInput.optimized_documents || []

                html += `
                    <div class="debug-info" style="background: #e8f5e8; border-color: #c3e6c3;">
                        <strong>ü§ñ LLM Input Optimization Information:</strong><br>
                        üìä Original matched documents: ${llmInput.total_matches || 0}<br>
                        üìù Optimized documents: ${optimizedDocs.length}<br>
                        üéØ Estimated tokens: ${tokenEstimate.toLocaleString()}<br>
                        üö® Token status: ${tokenEstimate > 3500 ? '‚ö†Ô∏è Exceeds recommended value' : tokenEstimate > 2500 ? '‚ö° Close to limit' : '‚úÖ Safe range'}
                    </div>
                `

                // Display optimized documents
                if (optimizedDocs.length > 0) {
                    html += `
                        <div class="debug-info" style="background: #f0f8ff; border-color: #b3d9ff;">
                            <strong>üìÑ Optimized Document Content:</strong><br>
                    `

                    optimizedDocs.forEach((doc, index) => {
                        const isTruncated = doc.truncated
                        const truncatedFlag = isTruncated ? ' üìÑ[Truncated]' : ' üìÑ[Complete]'
                        html += `
                            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                                <strong>${index + 1}. ${doc.title}${truncatedFlag}</strong> 
                                <span class="result-score">Match rate: ${(doc.score * 100).toFixed(1)}%</span><br>
                                <div style="margin-top: 5px; color: #666; line-height: 1.4; max-height: 150px; overflow-y: auto;">
                                    ${doc.content.substring(0, 300)}${doc.content.length > 300 ? '...' : ''}
                                </div>
                            </div>
                        `
                    })

                    html += `</div>`
                }

                // Complete LLM input data (collapsible display)
                html += `
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #007bff; font-weight: bold;">
                            üìã View Complete LLM Input Data
                        </summary>
                        <pre style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px;">${JSON.stringify(data.llm_input, null, 2)}</pre>
                    </details>
                `
            }

            resultsDiv.innerHTML = html
        }

        // Event listeners
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault()
            const query = searchInput.value.trim()
            if (query) {
                performSearch(query)
            }
        })

        // Add quick test buttons after page load
        document.addEventListener('DOMContentLoaded', () => {
            addQuickTestButtons()
            // Display service status check
            resultsDiv.innerHTML = `
                <div class="debug-info" style="background: #fff3cd; border-color: #ffeaa7;">
                    <strong>üìã Instructions:</strong><br>
                    1. Please ensure backend service is started: python simple_offline_backend.py<br>
                    2. Backend service should be running at http://localhost:5000<br>
                    3. Enter a question and click the search button to test<br>
                    4. You can use the quick test buttons below
                </div>
            `
        });
    </script>
</body>

</html>