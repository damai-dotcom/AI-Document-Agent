<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢åŒ¹é…è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .search-form {
            margin-bottom: 30px;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .search-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        .search-btn:hover {
            background: #0056b3;
        }
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
        }
        .result-item {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .result-score {
            background: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .result-content {
            color: #666;
            line-height: 1.5;
            max-height: 100px;
            overflow-y: auto;
        }
        .keywords {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 15px;
        }
        .keyword {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            margin: 2px;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æœç´¢åŒ¹é…è°ƒè¯•å·¥å…·</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            æµ‹è¯•æ–‡æ¡£åŒ¹é…é€»è¾‘ï¼ŒæŸ¥çœ‹LLMè°ƒç”¨å‰çš„æœç´¢ç»“æœ
        </p>

        <form class="search-form" id="searchForm">
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæˆ‘ä»¬å…¬å¸çš„è¯·å‡æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ"
                value="æˆ‘ä»¬å…¬å¸çš„è¯·å‡æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„"
            >
            <button type="submit" class="search-btn" id="searchBtn">
                ğŸ” æµ‹è¯•æœç´¢åŒ¹é…
            </button>
        </form>

        <div id="results" class="results"></div>
    </div>

    <script>
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsDiv = document.getElementById('results');

        // é¢„è®¾æµ‹è¯•é—®é¢˜ï¼ˆåŒ…å«åŒä¹‰è¯æµ‹è¯•å’ŒTokenå‹åŠ›æµ‹è¯•ï¼‰
        const testQueries = [
            'æˆ‘ä»¬å…¬å¸çš„è¯·å‡æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„',
            'å¦‚ä½•ç”³è¯·å¹´å‡',
            'å‘˜å·¥ç¦åˆ©æœ‰å“ªäº›',
            'æ–°å‘˜å·¥å…¥èŒæµç¨‹',
            'ç»©æ•ˆè€ƒæ ¸åˆ¶åº¦æ˜¯ä»€ä¹ˆ',
            'ç¦»èŒéœ€è¦åŠç†ä»€ä¹ˆæ‰‹ç»­',
            'åŸ¹è®­å‘å±•æœºä¼š',
            'leave process',
            'annual leave',
            'employee benefits',
            'onboarding process',
            'performance review',
            'resignation process',
            'training and development',
            // åŒä¹‰è¯æµ‹è¯•
            'æˆ‘æƒ³ä¼‘å‡å‡ å¤©',
            'time off policy',
            'sick leave application',
            'æˆ‘è¦è¾èŒ',
            'å·¥èµ„å¾…é‡å¦‚ä½•',
            'salary and benefits',
            'performance evaluation',
            'å·¥ä½œè¡¨ç°è¯„ä¼°',
            // Tokenå‹åŠ›æµ‹è¯•
            'è¯·è¯¦ç»†è¯´æ˜å…¬å¸æ‰€æœ‰çš„è§„ç« åˆ¶åº¦å’Œç¦åˆ©å¾…é‡æ”¿ç­–',
            'æˆ‘æƒ³äº†è§£å…¬å¸çš„å®Œæ•´åŸ¹è®­ä½“ç³»ä»¥åŠèŒä¸šå‘å±•è·¯å¾„è§„åˆ’',
            'è¯·è¯¦ç»†ä»‹ç»å‘˜å·¥æ‰‹å†Œä¸­çš„æ‰€æœ‰æ¡æ¬¾å’Œæ³¨æ„äº‹é¡¹'
        ];

        // æ·»åŠ å¿«é€Ÿæµ‹è¯•æŒ‰é’®
        function addQuickTestButtons() {
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.marginBottom = '20px';
            buttonsDiv.innerHTML = '<h3>å¿«é€Ÿæµ‹è¯•ï¼š</h3>';
            
            testQueries.forEach(query => {
                const btn = document.createElement('button');
                btn.textContent = query;
                btn.style.cssText = 'margin: 5px; padding: 8px 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;';
                btn.onclick = () => {
                    searchInput.value = query;
                    searchForm.dispatchEvent(new Event('submit'));
                };
                buttonsDiv.appendChild(btn);
            });
            
            searchForm.parentNode.insertBefore(buttonsDiv, searchForm.nextSibling);
        }

        async function performSearch(query) {
            searchBtn.disabled = true;
            searchBtn.textContent = 'ğŸ”„ æœç´¢ä¸­...';
            resultsDiv.innerHTML = '<div class="loading">æ­£åœ¨æœç´¢åŒ¹é…æ–‡æ¡£...</div>';

            try {
                // å°è¯•å¤šä¸ªå¯èƒ½çš„APIç«¯ç‚¹
                const apiUrls = [
                    'http://localhost:5000/api/search-debug',
                    '/api/search-debug'
                ];
                
                let response;
                let lastError;
                
                for (const apiUrl of apiUrls) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json;charset=UTF-8'
                            },
                            body: JSON.stringify({ query: query })
                        });
                        
                        if (response.ok) {
                            break;
                        }
                    } catch (err) {
                        lastError = err;
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(lastError?.message || `æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚è¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:5000`);
                }

                const data = await response.json();
                displayResults(data, query);

            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <strong>æœç´¢å¤±è´¥:</strong> ${error.message}<br>
                        <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                        1. ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨: python simple_offline_backend.py<br>
                        2. æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œåœ¨ http://localhost:5000<br>
                        3. æ£€æŸ¥æ˜¯å¦æœ‰é˜²ç«å¢™é˜»æ­¢è¿æ¥
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ğŸ” æµ‹è¯•æœç´¢åŒ¹é…';
            }
        }

        function displayResults(data, query) {
            let html = '';

            // è°ƒè¯•ä¿¡æ¯
            if (data.debug) {
                html += `
                    <div class="debug-info">
                        <strong>ğŸ” è°ƒè¯•ä¿¡æ¯:</strong><br>
                        åŸå§‹æŸ¥è¯¢: "${data.debug.original_query}"<br>
                        æå–å…³é”®è¯: [${data.debug.keywords.map(k => `"${k}"`).join(', ')}]<br>
                        æœç´¢è€—æ—¶: ${data.debug.search_time || 'N/A'}ms<br>
                        åŒ¹é…æ–‡æ¡£æ•°: ${data.debug.matched_docs || 0}<br>
                        æ€»æ–‡æ¡£æ•°: ${data.debug.total_docs || 0}
                    </div>
                `;
            }

            // å…³é”®è¯æ˜¾ç¤º
            if (data.debug && data.debug.keywords) {
                html += `
                    <div class="keywords">
                        <strong>ğŸ¯ æå–çš„å…³é”®è¯:</strong><br>
                        ${data.debug.keywords.map(k => `<span class="keyword">${k}</span>`).join('')}
                    </div>
                `;
            }

            // æœç´¢ç»“æœ
            if (data.results && data.results.length > 0) {
                html += `<h3>ğŸ“„ åŒ¹é…çš„æ–‡æ¡£ (${data.results.length} ä¸ª):</h3>`;
                
                data.results.forEach((result, index) => {
                    html += `
                        <div class="result-item">
                            <div class="result-title">
                                ${result.title}
                                <span class="result-score">åŒ¹é…åº¦: ${(result.score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="result-content">
                                ${result.content.substring(0, 200)}...
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="error">
                        âŒ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡æ¡£
                        ${data.debug ? `<br>å»ºè®®: å°è¯•ä½¿ç”¨å…³é”®è¯å¦‚ "è¯·å‡"ã€"å¹´å‡"ã€"å…¥èŒ"ã€"ç¦åˆ©" ç­‰` : ''}
                    </div>
                `;
            }

            // LLMè¾“å…¥é¢„è§ˆå’ŒTokenä¼˜åŒ–ä¿¡æ¯
            if (data.llm_input) {
                const llmInput = data.llm_input;
                const tokenEstimate = llmInput.token_estimate || 0;
                const optimizedDocs = llmInput.optimized_documents || [];
                
                html += `
                    <div class="debug-info" style="background: #e8f5e8; border-color: #c3e6c3;">
                        <strong>ğŸ¤– LLMè¾“å…¥ä¼˜åŒ–ä¿¡æ¯:</strong><br>
                        ğŸ“Š åŸå§‹åŒ¹é…æ–‡æ¡£æ•°: ${llmInput.total_matches || 0}<br>
                        ğŸ“ ä¼˜åŒ–åæ–‡æ¡£æ•°: ${optimizedDocs.length}<br>
                        ğŸ¯ é¢„ä¼°Tokenæ•°: ${tokenEstimate.toLocaleString()}<br>
                        ğŸš¨ TokençŠ¶æ€: ${tokenEstimate > 3500 ? 'âš ï¸ è¶…å‡ºå»ºè®®å€¼' : tokenEstimate > 2500 ? 'âš¡ æ¥è¿‘é™åˆ¶' : 'âœ… å®‰å…¨èŒƒå›´'}
                    </div>
                `;
                
                // æ˜¾ç¤ºä¼˜åŒ–åçš„æ–‡æ¡£
                if (optimizedDocs.length > 0) {
                    html += `
                        <div class="debug-info" style="background: #f0f8ff; border-color: #b3d9ff;">
                            <strong>ğŸ“„ ä¼˜åŒ–åçš„æ–‡æ¡£å†…å®¹:</strong><br>
                    `;
                    
                    optimizedDocs.forEach((doc, index) => {
                        const isTruncated = doc.truncated;
                        const truncatedFlag = isTruncated ? ' ğŸ“„[å·²æˆªæ–­]' : ' ğŸ“„[å®Œæ•´]';
                        html += `
                            <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">
                                <strong>${index + 1}. ${doc.title}${truncatedFlag}</strong> 
                                <span class="result-score">åŒ¹é…åº¦: ${(doc.score * 100).toFixed(1)}%</span><br>
                                <div style="margin-top: 5px; color: #666; line-height: 1.4; max-height: 150px; overflow-y: auto;">
                                    ${doc.content.substring(0, 300)}${doc.content.length > 300 ? '...' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                // å®Œæ•´çš„LLMè¾“å…¥æ•°æ®ï¼ˆæŠ˜å æ˜¾ç¤ºï¼‰
                html += `
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #007bff; font-weight: bold;">
                            ğŸ“‹ æŸ¥çœ‹å®Œæ•´LLMè¾“å…¥æ•°æ®
                        </summary>
                        <pre style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px;">${JSON.stringify(data.llm_input, null, 2)}</pre>
                    </details>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        // äº‹ä»¶ç›‘å¬
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                performSearch(query);
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ å¿«é€Ÿæµ‹è¯•æŒ‰é’®
        document.addEventListener('DOMContentLoaded', () => {
            addQuickTestButtons();
            // æ˜¾ç¤ºæœåŠ¡çŠ¶æ€æ£€æŸ¥
            resultsDiv.innerHTML = `
                <div class="debug-info" style="background: #fff3cd; border-color: #ffeaa7;">
                    <strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜:</strong><br>
                    1. è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨: python simple_offline_backend.py<br>
                    2. åç«¯æœåŠ¡åº”è¯¥è¿è¡Œåœ¨ http://localhost:5000<br>
                    3. è¾“å…¥é—®é¢˜åç‚¹å‡»æœç´¢æŒ‰é’®è¿›è¡Œæµ‹è¯•<br>
                    4. å¯ä»¥ä½¿ç”¨ä¸‹æ–¹çš„å¿«é€Ÿæµ‹è¯•æŒ‰é’®
                </div>
            `;
        });
    </script>
</body>
</html>